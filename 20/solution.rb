ALGO = DATA.gets.strip
INPUT = DATA.read.strip.split("\n").map { _1.each_char.to_a }

Image = Struct.new(:data, :inf)
INITIAL = Image.new(INPUT, '.')

def pad_image(image)= image.data.map { [image.inf] + _1 + [image.inf] }.then do
  _1.unshift([image.inf] * _1.first.size)
  _1.push([image.inf] * _1.first.size)

  Image.new(_1, image.inf)
end

def enhance_image(image)
  new_data = image.data.each_with_object([]).with_index do |(line, new), y|
    line.each_with_index do |v, x|
      address = [y - 1, y, y + 1]
        .flat_map { |y| [[x - 1, y], [x, y], [x + 1, y]] }
        .map { |(x, y)| ((0...line.size).cover?(x) && (0...image.data.size).cover?(y)) ? image.data[y][x] : image.inf }
        .map { _1 == '#' ? "1" : "0" }.join.to_i(2)
      new[y] ||= []
      new[y][x] = ALGO[address]
    end
  end

  Image.new(new_data, ALGO[(image.inf == "#" ? 0b1111_1111_1 : 0)])
end

def print_image(image)
  puts image.data.map(&:join).join("\n")
end

# Part 1

final_pt1 = 2.times.inject(INITIAL) do |image, n|
  enhance_image(pad_image(image))
end

puts "== After 2 iterations =="
puts "#{final_pt1.data.flatten.count { _1 == '#' }} pixels are lit"

# Part 2

final_pt2 = 50.times.inject(INITIAL) do |image, n|
  enhance_image(pad_image(image))
end

puts "== After 50 iterations =="
puts "#{final_pt2.data.flatten.count { _1 == '#' }} pixels are lit"

__END__
#####.#.##.####.#....#.###.##.###.#..#.#...##....#.#.##..#...#..##.##.####.#....##.#.#......###..#.#.#...##.#...###...#.#...##....####....#...#.####..#.#.####....####..#..#..#....###...#..#.###.##..##..####....####.###..#.#.##.#.###.##....####.#####.##.#.#...##.######....##...#####.##..###.####.#.##..##...#.#..#.#.#.....#..#..##..##..######..#..#..##..#.##.#..###.#....#.#.#.#.#.#..#.##.#.#....###.#.#..#....#.##..##.##...#..#####.###.......###.###.#..#.##.######.#######.##..##.##..#.##......#####.#.....#..#.

.##..##...#...#...#.##.###.##.......#....#.#..#...###.##.###..#.##.###...#..#..######...#####.#....#
#.......###..##.#.#.....###.#..#..#.#..#...#..##.#.#.#.#.#.#.#.#..####.#.#.#.#....####.##.#.#.#.###.
...###..#..##.#.##..#.#..###...#..#.###.#.###....##...####..#.#.#.###.#.#..##..#.#...#########.##.#.
.#...##..#.####..#.#.#..##.#.#.##.##..##.#..#.#..##.##...#..#.#..#..#....##....###.##.###..#.#..####
..###..#.#.#.#.#..#...##......#..###.#.#..##....#.#####....####..##..####.#.####..####...####.#..#..
.##.##.#.#..#.#.##.######.##..###....#####.#...#..#...##.######..#.##.###...##.#.#.#.#.#.......#.#.#
.......#..#..#.##.###....#.#..##..#.#..#...#..##.#..#.#.#...######.####..###...###.#....#...#..#.###
.####.####...........#.#....#.#.#...#.###.##.##...#.####...##..###..###..###.##...#.##.##.#.####..#.
######.#....####.#.##..#.##.#.######...##.#...##.#.###..##....#.......##.#.#.#.####.#.#.....#.#...##
#.##..##.....#.#.###..##..##..###....##..##.#.#..#...####.#.#.###.##.##.#.####.#.###.#..#...#.##..##
##.###.###.#....###.####.##..##..#.#.#.#.#...#....###..#..#..##...#.##..##..#.#.#######...###...##.#
##.##....#...##......#.#....#...##.#.#..#....#.###.#..###.#..#..###.##.....#...#.#.#.#.##...#..##...
.#..#..#..#####....####..#.###.#.#.##..#......####..###.##...##.#..#..........#..##.##...###.##..##.
........##..#..#...####..#.##.#.#....#..#..#......#.##..#.##...##.#..........#.#.#.#.#.#......######
..#.##.....###...###.#.##.#######.###.###.####.##.#..##..#...#...#.#####....##...#.####..########..#
#.#..####..#....#..###..#.#.##...#.###.###..#.....#....#...###.###.######.##.##.#....##.#.##.###...#
#..#.....#.#.#.#.#....#...###..##..#..#.##...#.###..#......##....#.##.###.#.#.#.###.##.####.#..#..#.
.##....#.#.###.##.###.#.##....##.##.#..#.##...##...###....###..#..#.###.##.#..#.#.#.##.#...#.##.#.#.
..####.#.##.##.#.#.#.....##.#...##...##.#######.###...#..##...#.###..#..#..###..##.#.##.......#.#.##
#..#####..####.#.###.##.#.#.#.......#..##.####.#...#.###.###..##.....##..#####..####....####.##.#.#.
.#...##.#.###.#.########......#...###...##...##.##..#.#.#...##...#.#.#..#######.###...###.#.#.#.#...
..#..##...#.###.#...#..#.#.##.#.#..#...###..##...##..#.##.##.##..#.#.....#.#######...#..##.###.#..##
.........#...##..#...##...##.#.....#.#..#..#..###......#.#..#.###.###.#...#.###.####.....#....#.#.##
.##.###.######..#######..#...#...#..#.#.##...##.###.#.##.##..##.###.#.###.#.####.###....#.#.#..#....
.#.##...####.#.##.#..##.##..##.#.##...#..##...#####...###.##.##..#..#......#####.....#.#..##..#..#..
#..#####.###...#..#.....#.##.#..##...#.#...##....####.#..#..####..#..#..##...###...###.######..##...
##...#...####...###.#.######....##.##..#####.#...###..#..#.#..#...###.#.#.##.###.#...##....#.##...#.
..#.#..##..#.#.#.#..##..#.#..#.##.#.#..#..#.#.#.####..#.........#.####..##.#.#.#.##..##.#..##..#....
###.......#.##..#.#.##.#####..#..#..#####.###.#.....##.#..#..#..###..#######......####....#....#...#
##........#...##..#####.###.#....#.#.#.##.#####...#.##..###...######....##.##.#...###.##.#..##..####
..##..##...#.#..####.#.#............#.#...#.#....##..#..########.#.##.##.##.#.#.#.###.##.#.######...
#.#.##.##..#.##..##..#.##.#..#.#.#.#.#####.#.####.###....##.#..##..#...#.#...####..##.#.#..###.#..##
...##.##..#..#####..#..#.#.#.......#.##..###.##.##.#..###....##..#....####.##.#..#..#.#...#######.##
.##.#.#...####...#.#..#########.#.###..###..#...###.##.#.#.##....##..#.#####..#.##.......#.#.#..##..
#...#.#...###.#.#.......##......#####..#....###..##.#.#.....#....#...#.###.#.##.####.....#..###.#.##
##.#####.###.....###..#.##..####...###.#.##.######...#####...#.#..##.#.#####.#####..#..##.#..#.#..##
#.##.########.#.###...#.#.#.###.###..##.##.#....##..#.#.##.#.......#.######.###..##.####.##.####.###
###.##..#.#...#...###.....#..#....#.#....###....##...###.#...##......#.##..##..####.###.#.#......##.
.##..##..##..####.##..#.#####.####.#.#.##..#.......#...#..######.#####.#..#.#..##....#.##.#...#...#.
..##........#..#.#.#.#.###.###.#####...##...#.#.##.#.#...###...##..#.##.###.#....#.###..##.##.####.#
.##.#....#..#..##.#.####.##.####..##....##..#..#.#.#.####.#.##.##.#.#.##..#.##.##.###.##.#....#.#.#.
.##..###....#..#.##....#.....#.##.....#.##.#.##.###.#.#..#...#..##.##...##.#.###.###..#.###...#..##.
##.##..#.#.##...#.###...#.##.#.....#..#..#.##...#.##...#####.......#.###..#.##.##.###.#.#....#.###..
##.#####....#.....#.#...##.#.#..##...#.#.##...#####...........#.####.....####..#..##...####..####.#.
#.##...#.##.####.#.#.#.##.#....###.##......###...#.##.#...#####.##..#.##.##...#....##.##.##.###..#.#
#..#..#.###.##..##..#######..####...#####.##.#.#.#...#..###.#..#.#.#..##..##...##..####.###.##.###..
.###.##....##..#.#..####...#.#.#..#.#..#.#.###....##........#.####.#...#...#..####.#.....#.##....###
#..#####..##..####.#####.###.#.#..#..#.#.#.##...##...####.#.#.###.....#..##.#.##.##......#...#.#.##.
#####.##.###....#...#..###..#..#..#####..#..#..###.####..##....##..####.##.##.##.##.#.#..#..##..##..
#.#..####..#..###..###.#....#.#..#..#..#...##...#####.....###...#.#.....#####.###....#.###...#####..
...........####..##.#.####.####.#.##.#.#.#.##...###.#.##.##.####.....##...###....#.#..#.....##.#.#.#
#......##...##.##..#.##.#.##..#..##.###....##...##....#...##.#.##.#..#....####..#.##...####.....##..
########..######.#.##..##.#...#...#.##.##...#..##..##..##..#.##...#.##.#.###.###.#.#.#.#..#..#..##..
.#.#..#######.....##..#.##.#..###..##.#..#.#.....###.#...#..###.##..####...##..#.#....###..##.#..#.#
..###..#.##.#.#.....#..#..####..###..#..#...#.........#..#####.####..####...##...#.#.##.#.#.##.###.#
.#.....##.#..######....#.#.#.###.#.#...#.##.....###.##.#..#.##.##.#....###..###.#.#.###..####.#....#
.#..#.......#.#.##...........#...###.#..##...##..#.#...##.####..####......#.#####..######.#.....####
#..###..##..#.##.####..########.#.##..######..####..#..##.#.#.#.#.###.##.#..##.#..###.##.....#..##..
...######....#.#..#######.#.##.##.#.#..###......##..#..#.####.....#..###.#.###.#...###.#.#..#..#..##
###.#..#.......##.#..##..########.###..####.##..#.###..#.....#...##.....##..#.#.#.#.####...####.#..#
##.##...##.#.#..##########....#..#..#.##....#..#..##.####...#......##..#.##..#..####.#.##..##.#.##.#
.#.####.###....#.#....####...###.###..#.#...#..#.####.....#.#.#..##.....#.##...###.####..#.##.#...#.
#..##.#.#.###.......#.##.....##.###.##..#.###.##.#.########.###.#.###.#.....####..##.#.#.###.#####.#
#.###.#..###...##....#.....#.####.#.#...###..##.#..##....#...###.#.#.#.#..#..##..#.####...#......##.
.#...#..##.###..#.#.#..##.##..###..#.####.##.#.##.###.#...###.#.###....#.###.....#.#..###.#..#####..
##..##.#.#.#.#..##..####..#..#..#.##.##.#..#..###...####...#..###....#.###.#.#####.##.###.#.###...#.
##.....##..#.#..####....##..######...#.......#.##..##....#.#......#..####..###...###....#######.#..#
..###..###..##.####.#.....#.##..#..##..###..#.....##..#.#.........#####.....####.##.#.#...#.####.###
....###..##.######...#.#.#.#..##..#.##....##..#.....####.#####..#.#..#.#...##...#.##.###.#..######.#
.....#......##..#.#...#..##.##....#####..##.#.#.......#..##.#.#..###.####.##..#.#.#.##....#####.....
#####.#####.#.##....###......##...##..####..##..###.##..#..##..#....#.######.#####....###...#.##..#.
.######..###.#.####...#.##.#.##.##..#..#..######.##.###.##..#####..#.####.####.##.###...#....#####..
..##.#.##.#.###.#.##...##.##..##.###..#.....#..#.###...####....#.##.#.#...#####...#.#######.....##..
###...##.#...#.####.....#........##..#.#.####....#####.#.##...##..########.#...#..###.#..#.#..#.#.##
.#.#.##.####..#####...#..#..###..#.....####.#.#..#.#...#...#....#...####.##....##..#.###.###.#....#.
#.#...#.##...##.##..#..#..#....##..#...###.#...#.#.#.###...#...#..###...#.#.#.##.#####....##....###.
..#####.####.##.##.##.##...#########.###.##...#.#...####....#..#.####...#...#####....#.#...#..#.#...
.##...#.#.#.#..#.#.#.#..##..#..###.#.....#.#.#.#...#.##.##..#.####.######.##.#.#..#.###.#......#.##.
##.........###.....#.######.##.....##..####.#.##.####.#..####.##.#.#.#.######.#####....#.#######..#.
###.##.####.#.....#.#..#.###..###..#..#..#.##..##..#....##...##.#..#.#.#...#..###.#.#..#....#.#.#.##
#.#..###..##....##...#########..####.##.#..#..#.........##....##.#..#.......###..#....#.##.#...#.#.#
#..###..####.#..###.#.###..#.......###...#####...###.#...#....##..#..##.#.#.#.#.##.##...#.##....#.#.
###..###...######.......#.#....#####.....##.#..#....#.#.##..#..#..######..#..##.##.#.##.#.#.#####.##
..#.##.#.##.#..##...###.#####..##........#.#..#.###..##....#..####..#..###...#.#.##.##...##..##..###
..##.#...#...#..###.####..##..#....###.#####...##.##........###....#...####.#....#.#####.#...####.##
#....#..#...##..#..######..#.##...#.#..#...##.#.#.#.#.###..##.##.####.#.##.##..#...#...###.##.#..##.
.#..###...###.#...##.####.#........#......#..#.#..######.###..#.##..#.#.#.###.######.##.#.#..#..#.##
#...##....###.#.#....###..#..#...#.##..#.###.......##.##....#..####.##.#.##.#.####.#..#.#..##.#..##.
#.#...#..#.######.#.#.#....#.###.#.#.###.#.##.##.#.#.##..#.###.###.######..#...####.#.#.##...####.#.
#.....#.....#######.#.#..##.#..#.#.#......#.#.#.##...#...##########...##.###..##..#......##.#..#....
..##.##.#..#####..#...#.#..#...#....#...##..#####.#..#..#..##.##.#...#.#..####...#.##...#.#.##.#.##.
##..######...#.##..#.#.#..#..####....#.#....##.#.#....#.###.#..##.####....#.......##..##.#....#..##.
#######.#####.#..##..#.#####.##.#.#.#..#.....#....######.####.##.##....#.##.#.#.#...##.#.#.#..#...##
..#.##.###....#.#.#.#...#####.#..##..###....####...#..###...#.##.##.#.###.###.###.#...##.#.###.###.#
..##..##.#.####.####...##..##.....#..##.#.##...#.#..##.##.##.##.###..########.#####.#..###.#.##.#..#
.....##.#.#..###.##..#..#.#..###.#.####.#.....#.....##...##.##..##.#..###.###.#.....##..#.#..#......
##...###.####..##.##.#..#######..##.##......#..#.########.#####...#.......##.###.##..#..#...#.######
.#...##.#..###........####.#...###.#.###.#..#.###.##.#.#.#..##..#....#####......##.#.##...#.#.#.###.
#.###....#.......##.#......#.##..#.....####....#...#.#.###.#####.#....##....#.#.###..#.#.##.#.##..##
.####..##.###.....#.####....##....##..####.#####.#.#.#..###..#.##.#.##...#.##.##.#..##..###.#..#..##
